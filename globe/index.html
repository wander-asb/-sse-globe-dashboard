<!DOCTYPE HTML>
<html lang="en">
  <head>
    <title>WebGL Globe</title>
    <meta charset="utf-8">
    <style type="text/css">
      html {
        height: 100%;
      }
      body {
        margin: 0;
        padding: 0;
        background: #000000 url(/globe/loading.gif) center center no-repeat;
        color: #ffffff;
        font-family: sans-serif;
        font-size: 13px;
        line-height: 20px;
        height: 100%;
      }

      #info {

        font-size: 11px;
        position: absolute;
        bottom: 5px;
        background-color: rgba(0,0,0,0.8);
        border-radius: 3px;
        right: 10px;
        padding: 10px;

      }

      #currentInfo {
        width: 270px;
        position: absolute;
        left: 20px;
        top: 63px;

        background-color: rgba(0,0,0,0.2);

        /* border-top: 1px solid rgba(255,255,255,0.4); */
        padding: 10px;
      }

      a {
        color: #aaa;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      .bull {
        padding: 0 5px;
        color: #555;
      }

      #title {
        position: absolute;
        top: 20px;
        width: 270px;
        left: 20px;
        background-color: rgba(0,0,0,0.2);
        border-radius: 3px;
        font: 20px Georgia;
        padding: 10px;
      }

      .year {
        font: 16px Georgia;
        line-height: 26px;
        height: 30px;
        text-align: center;
        float: left;
        width: 90px;
        color: rgba(255, 255, 255, 0.4);

        cursor: pointer;
        -webkit-transition: all 0.1s ease-out;
      }

      .year:hover, .year.active {
        font-size: 23px;
        color: #fff;
      }

      #ce span {
        display: none;
      }

      #ce {
        width: 107px;
        height: 55px;
        display: block;
        position: absolute;
        bottom: 15px;
        left: 20px;
        background: url(/globe/ce.png);
      }

      #chatWidget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999;
        font-family: 'Segoe UI', sans-serif;
      }

      #chatIcon {
        border-radius: 50%;
        width: 56px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        overflow: hidden;
      }

      #chatIcon img {
        width: 54px;
        height: 54px;
        object-fit: contain;
      }

      #chatIcon:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 14px rgba(0,0,0,0.4);
      }

      #chatBox {
        width: 280px;
        height: 340px;
        background: #1a1a1a;
        border: 1px solid #00B5E2;
        border-radius: 12px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        overflow: hidden;
        display: none;
        flex-direction: column;
        position: absolute;
        bottom: 70px;
        right: 0;
      }

      .chatHeader {
        background: #00B5E2;
        color: white;
        padding: 10px 14px;
        font-weight: bold;
      }

      .chatMessages {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        font-size: 14px;
        color: #eee;
      }

      .message {
        margin-bottom: 8px;
      }

      #chatInput {
        width: 100%;
        padding: 10px;
        border: none;
        outline: none;
        background: #2c2c2c;
        color: white;
        font-size: 14px;
      }

      #kpiPanel {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 100;
      }

      .kpiBox {
        background: linear-gradient(135deg, #1A1A1A 0%, #2C2C2C 100%);
        border-left: 5px solid #00B5E2;
        border-radius: 12px;
        padding: 14px 18px;
        width: 180px;
        color: #ffffff;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        transition: transform 0.2s ease;
      }

      .kpiBox:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.6);
      }

      .kpiLabel {
        font-size: 13px;
        color: #b0b0b0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .kpiValue {
        font-size: 20px;
        font-weight: 600;
        color: #00B5E2;
        margin-top: 6px;
      }



    </style>
  </head>
  <body>

  <!-- Chat Widget -->
  <div id="chatWidget">
    <div id="chatIcon">
      <img src="/globe/blipinho-widget.png" alt="Chat" />
    </div>
    <div id="chatBox">
      <div class="chatHeader">BlipID Chat</div>
      <div class="chatMessages" id="chatMessages">
        <div class="message">üëã Ol√°! Seja bem-vindo ao BlipID 2025.</div>
        <div class="message">üìç Estamos transmitindo direto de S√£o Paulo.</div>
      </div>
      <input type="text" id="chatInput" placeholder="Digite sua mensagem..." />
    </div>
  </div>

  <div id="container"></div>

  <!-- <div id="info">
    <strong><a href="http://www.chromeexperiments.com/globe">WebGL Globe</a></strong> <span class="bull">&bull;</span>¬†Created by the Google Data Arts Team <span class="bull">&bull;</span> Data acquired from <a href="http://sedac.ciesin.columbia.edu/gpw/">SEDAC</a>
  </div> -->

  <div id="currentInfo">
    <span id="year1990" class="year"></span>
    <span id="year1995" class="year"></span>
    <span id="year2000" class="year"></span>
  </div>

  <!-- <div id="title">
    World Population
  </div> -->

  <!-- <a id="ce" href="http://www.chromeexperiments.com/globe">
    <span>This is a Chrome Experiment</span>
  </a> -->

  <script type="text/javascript" src="/globe/third-party/Detector.js"></script>
  <script type="text/javascript" src="/globe/third-party/three.min.js"></script>
  <script type="text/javascript" src="/globe/third-party/Tween.js"></script>
  <script type="text/javascript" src="/globe/globe.js"></script>
  <script type="text/javascript">

    if(!Detector.webgl){
      Detector.addGetWebGLMessage();
    } else {

      var years = ['1990','1995','2000'];
      var container = document.getElementById('container');
      var globe = new DAT.Globe(container);

      console.log(globe);
      var i, tweens = [];
      
      var settime = function(globe, t) {
        return function() {
          new TWEEN.Tween(globe).to({time: t/years.length},500).easing(TWEEN.Easing.Cubic.EaseOut).start();
          var y = document.getElementById('year'+years[t]);
          if (y.getAttribute('class') === 'year active') {
            return;
          }
          var yy = document.getElementsByClassName('year');
          for(i=0; i<yy.length; i++) {
            yy[i].setAttribute('class','year');
          }
          y.setAttribute('class', 'year active');
        };
      };
      
      // for(var i = 0; i<years.length; i++) {
      //   var y = document.getElementById('year'+years[i]);
      //   y.addEventListener('mouseover', settime(globe,i), false);
      // }
      
      var xhr;
      TWEEN.start();
      
      // xhr = new XMLHttpRequest();
      // xhr.open('GET', '/app/population909500.json', true);
      // xhr.open('GET', 'http://localhost:8000/dados-populacionais', true);
      // xhr.onreadystatechange = function(e) {
      //   if (xhr.readyState === 4) {
      //     if (xhr.status === 200) {
      //       var data = JSON.parse(xhr.responseText);
      //       window.data = data;
      //       for (i=0;i<data.length;i++) {
      //         globe.addData(data[i][1], {format: 'magnitude', name: data[i][0], animated: true});
      //       }
      //       globe.createPoints();
      //       settime(globe,0)();
      //       globe.animate();
      //       document.body.style.backgroundImage = 'none';
      //     }
      //   }
      // };
      // xhr.send(null);

    xhr = new XMLHttpRequest();
    xhr.open('GET', 'http://localhost:8000/dados-populacionais', true);
    xhr.onreadystatechange = function(e) {
      if (xhr.readyState === 4 && xhr.status === 200) {
        var data = JSON.parse(xhr.responseText);
        window.data = data;

        const latMin = -56;
        const latMax = 33;  
        const lonMin = -120;
        const lonMax = -30; 

        for (let i = 0; i < data.length; i++) {
          const ano = data[i][0];
          const dados = data[i][1];

          const filtrados = [];
          for (let j = 0; j < dados.length; j += 3) {
            const lat = dados[j];
            const lon = dados[j + 1];
            const mag = dados[j + 2];

            if (lat >= latMin && lat <= latMax && lon >= lonMin && lon <= lonMax) {
              filtrados.push(lat, lon, mag);
            }
          }

          if (filtrados.length > 0) {
            globe.addData(filtrados, {
              format: 'magnitude',
              name: ano,
              animated: true
            });
          }
        }

        globe.createPoints();
        settime(globe, 0)();
        globe.animate();
        document.body.style.backgroundImage = 'none';
      }
    };
    xhr.send(null);

    // const eventSource = new EventSource('http://localhost:8000/eventos');

    // let iniciou = false;

    // eventSource.onmessage = function(event) {
    //   const series = JSON.parse(event.data);

    //   const latMin = -56;
    //   const latMax = 33;
    //   const lonMin = -120;
    //   const lonMax = -30;

    //   for (let i = 0; i < series.length; i++) {
    //     const nome = series[i][0];
    //     const dados = series[i][1];

    //     const filtrados = [];
    //     for (let j = 0; j < dados.length; j += 3) {
    //       const lat = dados[j];
    //       const lon = dados[j + 1];
    //       const mag = dados[j + 2];

    //       if (lat >= latMin && lat <= latMax && lon >= lonMin && lon <= lonMax) {
    //         filtrados.push(lat, lon, mag);
    //       }
    //     }

    //     if (filtrados.length > 0) {
    //       globe.addData(filtrados, {
    //         format: 'magnitude',
    //         name: nome,
    //         animated: true
    //       });
    //     }
    //   }

    //   if (!iniciou) {
    //     globe.createPoints();    
    //     settime(globe, 0)();     
    //     globe.animate();       
    //     iniciou = true;
    //   }

    //   document.body.style.backgroundImage = 'none';
    // };

      let currentYearIndex = 0;

      function advanceYear() {
        settime(globe, currentYearIndex)();
        updateKPI(currentYearIndex);
        currentYearIndex = (currentYearIndex + 1) % years.length;
      }

      setInterval(advanceYear, 500);

      
      function updateKPI(yearIndex) {
        const yearLabel = years[yearIndex];
        const yearData = window.data[yearIndex][1];

        const totalPop = yearData.reduce((sum, val, idx) => {
          return idx % 3 === 2 ? sum + val : sum;
        }, 0);

        document.querySelector('.kpiValue').innerText = totalPop.toLocaleString() + ' pessoas';
      }

    }

  </script>

  <script>
    const chatIcon = document.getElementById('chatIcon');
    const chatBox = document.getElementById('chatBox');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');

    let isChatOpen = false;

    chatIcon.addEventListener('mouseover', () => {
      chatBox.style.display = 'flex';
      isChatOpen = true;
    });

    chatBox.addEventListener('mouseleave', () => {
      chatBox.style.display = 'none';
      isChatOpen = false;
    });

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && chatInput.value.trim() !== '') {
        const msg = document.createElement('div');
        msg.className = 'message';
        msg.textContent = `üßë‚Äçüíª ${chatInput.value}`;
        chatMessages.appendChild(msg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        chatInput.value = '';
      }
    });
  </script>

    <div id="kpiPanel">
      <div class="kpiBox">
        <div class="kpiLabel">Mensagens</div>
        <div class="kpiValue">213 mi</div>
      </div>
      <div class="kpiBox">
        <div class="kpiLabel">Usu√°rios √önicos</div>
        <div class="kpiValue">87%</div>
      </div>
      <div class="kpiBox">
        <div class="kpiLabel">Crescimento</div>
        <div class="kpiValue">0.72%/ano</div>
      </div>
    </div>

  </body>

</html>
